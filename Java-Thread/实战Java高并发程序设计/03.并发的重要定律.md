# 03.并发的重要定律

标签（空格分隔）：实战Java高并发程序设计

---

使用多线程变成的最主要的两个目的：为了获得更好的性能；由于业务模型需要，确实需要多个执行实体。

其中，获得更好的性能是我们最为关注的，但是将串行程序改为并行程序究竟能提高多少性能呢？这里就有条定律来解释这一问题。

## Amdahl定律

Amdahl定义了串行系统并行化后的加速比的计算公式和理论上限：加速比 = 优化前的系统耗时 / 优化后的系统耗时

加速比越高，说明优化效果越好。

Amdahl定律的推导过程：

n表示处理器的个数，T表示时间，T1表示优化前耗时（一个处理器时的耗时），Tn表示使用n个处理器优化后的耗时，F是程序中只能串行执行的占比。

Tn = T1(F + (1 - F)/n)

加速比 = T1 / Tn = T1 / T1(F + (1 - F)/n) = 1 / (F + (1 - F)/n)

根据这个公式，如果CPU处理器趋于无穷大，那么加速比和系统的串行化率( F )成反比，如果系统中有50%的代码必须是串行代码，那么系统的最大加速比为2。

举个栗子：假设有一段程序共分为五个步骤执行，每个步骤执行完需花费100个时间单位，其中只有步骤2和步骤5可以并行，其余的都是串行。

根据上诉说明，如果执行步骤全是串行，则总耗时为500个时间单位；如果在双核处理器上，将步骤2和步骤5并行化后，总耗时为400个时间单位。

加速比 = 优化前的系统耗时 / 优化后的系统耗时 = 500 / 400 = 1.25

或者根据Amdahl公式，加速比 = 1 / (F + (1 - F)/n) = 1 / (0.6 + (1 - 0.6)/2) = 1.25 其中n就是处理器的核数，F就是串行程序所占的比例

上诉例子在极端的情况下，也就是处理器的个数无穷多，并行化后的步骤2和步骤5耗时趋向于0，此时的系统耗时仍大于300个时间单位，此时的加速比 = 500 / 300 = 1.67

由此可见，为了提高系统的速度，仅增加CPU处理器的数量并不能显著的降低系统耗时，需要从根本上的修改程序的串行行为，才能以最小的成本得到最大的加速比。

一句话总结Amdahl定律：CPU数量越多，串行化程序占比越低，优化效果越好。