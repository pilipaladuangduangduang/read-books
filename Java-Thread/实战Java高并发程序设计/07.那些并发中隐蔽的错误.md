# 07.并发中隐蔽的错误

标签（空格分隔）：实战Java高并发程序设计

---

## 并发而导致的值溢出的问题

值溢出是一种很常见的现象，在单线程程序中很容易就能解决，但在并发程序中，很难发现问题。

## 并发下的ArrayList

ArrayList是非线程安全的容器，多线程请勿使用ArrayList，否则会出现以下情况：

 - 程序正常，结果也是期望的，这说明了并发程序中有问题也不会每次都表现出来；

 - 程序异常，抛出java.lang.ArrayIndexOutOfBoundsException，因为ArrayList内部的数组在扩容的时候，由于没有锁的保护，不同线程读取的数组大小不一致而引发的；

 - 程序正常，单结果并非是我们期望的。

## 并发下的HashMap

HashMap也不是一个线程安全的容器，在并发环境中使用HashMap会出现以下情况：

 - 程序正常，结果也是期望的，这说明了并发程序中有问题也不会每次都表现出来；

 - 程序正常，单结果并非是我们期望的；

 - 程序永远无法结束，造成死循环，导致死机问题。

因为HashMap内部结构是链表 + 数据，多线程在遍历HashMap时，发生冲突有可能将链表变成环链表，从而导致死循环（JDK8以后解决了这个问题）。

## 错误的使用synchronized

synchronized关键字不能以Integer、Long、Double、String等包装类为锁，这些包装类都属于不可变对象，不同线程每次加锁可能会加在不同引用上，导致同步无效。